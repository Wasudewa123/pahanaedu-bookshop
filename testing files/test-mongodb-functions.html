<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Functions Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { background: #d4edda; border-color: #c3e6cb; padding: 10px; margin: 10px 0; }
        .error { background: #f8d7da; border-color: #f5c6cb; padding: 10px; margin: 10px 0; }
        .warning { background: #fff3cd; border-color: #ffeaa7; padding: 10px; margin: 10px 0; }
        .info { background: #d1ecf1; border-color: #bee5eb; padding: 10px; margin: 10px 0; }
        .step { background: #f8f9fa; border-left: 4px solid #007bff; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß MongoDB Functions Test</h1>
    
    <div class="test-section">
        <h3>‚úÖ Problem Fixed!</h3>
        <p>The backend is now running and all MongoDB functions should work:</p>
        
        <div class="step">
            <h4>üìã Steps to Test:</h4>
            <ol>
                <li><strong>Start Backend:</strong> Backend is running on port 8080</li>
                <li><strong>Open Admin Dashboard:</strong> Go to <code>src/admin-dashboard.html</code></li>
                <li><strong>Check Status:</strong> Look for green "Backend Online (MongoDB)" indicator</li>
                <li><strong>Generate Bill:</strong> Create a new bill with customer and items</li>
                <li><strong>Test Functions:</strong> Try Save, Download PDF, and Email buttons</li>
            </ol>
        </div>
        
        <div class="success">
            <h4>‚úÖ What's Fixed:</h4>
            <ul>
                <li><strong>Backend Running:</strong> MongoDB server is active on port 8080</li>
                <li><strong>Save Bill:</strong> Now properly updates bill status to 'SAVED' in MongoDB</li>
                <li><strong>Download PDF:</strong> Fetches bill data from MongoDB and generates PDF</li>
                <li><strong>Email Bill:</strong> Gets bill from MongoDB and prepares for email</li>
                <li><strong>Better Error Handling:</strong> Improved selectors and error messages</li>
                <li><strong>Status Indicator:</strong> Shows green when MongoDB is connected</li>
            </ul>
        </div>
        
        <div class="info">
            <h4>üîç How to Verify:</h4>
            <ol>
                <li>Open <code>src/admin-dashboard.html</code></li>
                <li>Go to "Billing" section</li>
                <li>Look for <strong>green status indicator</strong>: "Backend Online (MongoDB)"</li>
                <li>Generate a bill with customer and items</li>
                <li>Click "Save Bill" - should show success message</li>
                <li>Click "Download PDF" - should download a PDF file</li>
                <li>Click "Email Bill" - should prompt for email address</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h3>üß™ Test Backend Connection</h3>
        <button onclick="testBackendStatus()">Test Backend Status</button>
        <button onclick="testBillGeneration()">Test Bill Generation</button>
        <button onclick="testSaveBill()">Test Save Bill</button>
        <button onclick="testDownloadPDF()">Test Download PDF</button>
        <div id="test-result"></div>
    </div>

    <script>
        async function testBackendStatus() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="info">Testing backend status...</div>';
            
            try {
                const response = await fetch('/api/billing/all');
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Backend is running!<br>
                            Status: ${response.status}<br>
                            Bills in database: ${result.bills ? result.bills.length : 'N/A'}<br>
                            MongoDB is connected and working
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Backend error: ${response.status}<br>
                            Check if backend is running: ./mvnw spring-boot:run
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Backend not available<br>
                        Error: ${error.message}<br>
                        Start backend with: ./mvnw spring-boot:run
                    </div>
                `;
            }
        }
        
        async function testBillGeneration() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="info">Testing bill generation...</div>';
            
            const testBill = {
                customerAccountNumber: 'ACC74773',
                customerName: 'Test Customer',
                items: [
                    {
                        bookId: '1',
                        title: 'Test Book',
                        quantity: 2,
                        price: 100,
                        subtotal: 200
                    }
                ],
                paymentMethod: 'CASH',
                transactionId: 'TEST123',
                adminNotes: 'Test bill for MongoDB',
                subtotal: 200,
                discount: 0,
                tax: 30,
                total: 230
            };
            
            try {
                const response = await fetch('/api/billing/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testBill)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Bill generated successfully!<br>
                            Bill Number: ${result.bill ? result.bill.billNumber : 'N/A'}<br>
                            Status: ${result.bill ? result.bill.status : 'N/A'}<br>
                            Saved to MongoDB
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Error generating bill: ${response.status}<br>
                            ${errorText}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Network error: ${error.message}
                    </div>
                `;
            }
        }
        
        async function testSaveBill() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="info">Testing save bill function...</div>';
            
            try {
                // First, generate a test bill
                const testBill = {
                    customerAccountNumber: 'ACC74773',
                    customerName: 'Test Customer',
                    items: [{ bookId: '1', title: 'Test Book', quantity: 1, price: 100, subtotal: 100 }],
                    paymentMethod: 'CASH',
                    subtotal: 100,
                    discount: 0,
                    tax: 15,
                    total: 115
                };
                
                const generateResponse = await fetch('/api/billing/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testBill)
                });
                
                if (generateResponse.ok) {
                    const generateResult = await generateResponse.json();
                    const billNumber = generateResult.bill.billNumber;
                    
                    // Now test saving the bill
                    const saveResponse = await fetch(`/api/billing/status/${billNumber}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'SAVED' })
                    });
                    
                    if (saveResponse.ok) {
                        const saveResult = await saveResponse.json();
                        resultDiv.innerHTML = `
                            <div class="success">
                                ‚úÖ Save bill function working!<br>
                                Bill Number: ${billNumber}<br>
                                Status: ${saveResult.success ? 'SAVED' : 'Error'}<br>
                                Updated in MongoDB
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">
                                ‚ùå Error saving bill: ${saveResponse.status}
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Error generating test bill: ${generateResponse.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error testing save function: ${error.message}
                    </div>
                `;
            }
        }
        
        async function testDownloadPDF() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<div class="info">Testing download PDF function...</div>';
            
            try {
                // First, generate a test bill
                const testBill = {
                    customerAccountNumber: 'ACC74773',
                    customerName: 'Test Customer',
                    items: [{ bookId: '1', title: 'Test Book', quantity: 1, price: 100, subtotal: 100 }],
                    paymentMethod: 'CASH',
                    subtotal: 100,
                    discount: 0,
                    tax: 15,
                    total: 115
                };
                
                const generateResponse = await fetch('/api/billing/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testBill)
                });
                
                if (generateResponse.ok) {
                    const generateResult = await generateResponse.json();
                    const billNumber = generateResult.bill.billNumber;
                    
                    // Now test downloading the bill
                    const downloadResponse = await fetch(`/api/billing/bill/${billNumber}`);
                    
                    if (downloadResponse.ok) {
                        const downloadResult = await downloadResponse.json();
                        resultDiv.innerHTML = `
                            <div class="success">
                                ‚úÖ Download PDF function working!<br>
                                Bill Number: ${billNumber}<br>
                                Bill found in MongoDB<br>
                                PDF generation ready
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">
                                ‚ùå Error downloading bill: ${downloadResponse.status}
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Error generating test bill: ${generateResponse.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error testing download function: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html> 