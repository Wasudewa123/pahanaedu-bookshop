<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Billing Debug - Pahana Book Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .loading {
            color: #007bff;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background: #28a745;
        }
        .status-offline {
            background: #dc3545;
        }
        .status-warning {
            background: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Comprehensive Billing System Debug</h1>
        <p>This will check all components: Backend, MongoDB, API endpoints, and Frontend</p>
        
        <div class="section">
            <h3>Step 1: Backend Status Check</h3>
            <button class="button" onclick="checkBackendStatus()">Check Backend Status</button>
            <div id="backend-status"></div>
        </div>
        
        <div class="section">
            <h3>Step 2: MongoDB Bills Collection Check</h3>
            <button class="button" onclick="checkMongoDBBills()">Check MongoDB Bills</button>
            <div id="mongodb-bills"></div>
        </div>
        
        <div class="section">
            <h3>Step 3: API Endpoints Test</h3>
            <div class="grid">
                <div>
                    <button class="button" onclick="testCustomersAPI()">Test Customers API</button>
                    <div id="customers-api"></div>
                </div>
                <div>
                    <button class="button" onclick="testBillingAPI()">Test Billing API</button>
                    <div id="billing-api"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>Step 4: Add Test Customer</h3>
            <button class="button success" onclick="addTestCustomer()">Add Test Customer</button>
            <div id="add-customer-result"></div>
        </div>
        
        <div class="section">
            <h3>Step 5: Test Bill Generation (Multiple Attempts)</h3>
            <button class="button warning" onclick="testBillGeneration1()">Test Bill Generation #1</button>
            <button class="button warning" onclick="testBillGeneration2()">Test Bill Generation #2</button>
            <button class="button warning" onclick="testBillGeneration3()">Test Bill Generation #3</button>
            <div id="bill-generation-results"></div>
        </div>
        
        <div class="section">
            <h3>Step 6: Check All Bills</h3>
            <button class="button" onclick="checkAllBills()">Check All Bills</button>
            <div id="all-bills"></div>
        </div>
        
        <div class="section">
            <h3>Step 7: Frontend Form Test</h3>
            <button class="button" onclick="testFrontendForm()">Test Frontend Form</button>
            <div id="frontend-form-test"></div>
        </div>
        
        <div class="section">
            <h3>Step 8: Complete Debug Report</h3>
            <button class="button danger" onclick="generateDebugReport()">Generate Debug Report</button>
            <div id="debug-report" class="debug-info"></div>
        </div>
    </div>

    <script>
        let debugData = {
            backendStatus: null,
            mongodbBills: [],
            customers: [],
            bills: [],
            apiTests: {},
            testResults: [],
            errors: []
        };

        async function checkBackendStatus() {
            const resultDiv = document.getElementById('backend-status');
            resultDiv.innerHTML = '<div class="loading">Checking backend status...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/admin/customers');
                if (response.ok) {
                    debugData.backendStatus = 'online';
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <span class="status-indicator status-online"></span>
                            ‚úÖ Backend is running successfully! (Port 8080)
                        </div>
                    `;
                } else {
                    debugData.backendStatus = 'error';
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <span class="status-indicator status-offline"></span>
                            ‚ùå Backend error: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                debugData.backendStatus = 'offline';
                debugData.errors.push({ type: 'backend', error: error.message });
                resultDiv.innerHTML = `
                    <div class="result error">
                        <span class="status-indicator status-offline"></span>
                        ‚ùå Backend connection failed: ${error.message}
                    </div>
                `;
            }
        }

        async function checkMongoDBBills() {
            const resultDiv = document.getElementById('mongodb-bills');
            resultDiv.innerHTML = '<div class="loading">Checking MongoDB bills collection...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/admin/bills');
                if (response.ok) {
                    const bills = await response.json();
                    debugData.mongodbBills = bills;
                    
                    if (bills.length > 0) {
                        resultDiv.innerHTML = `
                            <div class="result success">
                                ‚úÖ MongoDB bills collection is accessible!<br>
                                Found ${bills.length} bills in the collection.<br>
                                Latest bill: ${bills[0].billNumber} (${bills[0].customerName})
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result warning">
                                ‚ö†Ô∏è MongoDB bills collection is accessible but empty.<br>
                                No bills found in the collection.
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            ‚ùå Failed to access MongoDB bills collection: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                debugData.errors.push({ type: 'mongodb', error: error.message });
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå MongoDB connection error: ${error.message}
                    </div>
                `;
            }
        }

        async function testCustomersAPI() {
            const resultDiv = document.getElementById('customers-api');
            resultDiv.innerHTML = '<div class="loading">Testing customers API...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/admin/customers');
                if (response.ok) {
                    const customers = await response.json();
                    debugData.customers = customers;
                    debugData.apiTests.customers = { success: true, count: customers.length };
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Customers API working!<br>
                            Found ${customers.length} customers in database.
                        </div>
                    `;
                } else {
                    debugData.apiTests.customers = { success: false, error: response.status };
                    resultDiv.innerHTML = `
                        <div class="result error">
                            ‚ùå Customers API failed: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                debugData.apiTests.customers = { success: false, error: error.message };
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Customers API error: ${error.message}
                    </div>
                `;
            }
        }

        async function testBillingAPI() {
            const resultDiv = document.getElementById('billing-api');
            resultDiv.innerHTML = '<div class="loading">Testing billing API...</div>';
            
            try {
                // Test billing API by trying to get a customer
                const response = await fetch('http://localhost:8080/api/billing/customer/TEST123');
                if (response.ok) {
                    const data = await response.json();
                    debugData.apiTests.billing = { success: true, response: data };
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Billing API working!<br>
                            API endpoint is responding correctly.
                        </div>
                    `;
                } else {
                    debugData.apiTests.billing = { success: false, error: response.status };
                    resultDiv.innerHTML = `
                        <div class="result warning">
                            ‚ö†Ô∏è Billing API responded with status: ${response.status}<br>
                            (This might be normal if customer doesn't exist)
                        </div>
                    `;
                }
            } catch (error) {
                debugData.apiTests.billing = { success: false, error: error.message };
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Billing API error: ${error.message}
                    </div>
                `;
            }
        }

        async function addTestCustomer() {
            const resultDiv = document.getElementById('add-customer-result');
            resultDiv.innerHTML = '<div class="loading">Adding test customer...</div>';
            
            try {
                const customerData = {
                    accountNumber: 'ACC' + Date.now(),
                    name: 'Test Customer',
                    email: 'test@example.com',
                    phone: '1234567890',
                    address: 'Test Address'
                };
                
                const response = await fetch('http://localhost:8080/api/admin/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });
                
                if (response.ok) {
                    debugData.customers.push(customerData);
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ Test customer added successfully!<br>
                            Account Number: ${customerData.accountNumber}<br>
                            Name: ${customerData.name}
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `
                        <div class="result error">
                            ‚ùå Failed to add customer: ${error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Error adding customer: ${error.message}
                    </div>
                `;
            }
        }

        async function testBillGeneration1() {
            await testBillGeneration('Test Bill #1', {
                bookId: 'book1',
                title: 'Test Book 1',
                quantity: 1,
                price: 1000
            });
        }

        async function testBillGeneration2() {
            await testBillGeneration('Test Bill #2', {
                bookId: 'book2',
                title: 'Test Book 2',
                quantity: 2,
                price: 1500
            });
        }

        async function testBillGeneration3() {
            await testBillGeneration('Test Bill #3', {
                bookId: 'book3',
                title: 'Test Book 3',
                quantity: 3,
                price: 800
            });
        }

        async function testBillGeneration(testName, itemData) {
            const resultDiv = document.getElementById('bill-generation-results');
            resultDiv.innerHTML += `<div class="loading">Testing ${testName}...</div>`;
            
            try {
                // Get a customer first
                const customersResponse = await fetch('http://localhost:8080/api/admin/customers');
                if (!customersResponse.ok) {
                    resultDiv.innerHTML += `<div class="result error">‚ùå ${testName}: Failed to get customers</div>`;
                    return;
                }
                
                const customers = await customersResponse.json();
                if (customers.length === 0) {
                    resultDiv.innerHTML += `<div class="result error">‚ùå ${testName}: No customers found</div>`;
                    return;
                }
                
                const customer = customers[0];
                const subtotal = itemData.quantity * itemData.price;
                const tax = subtotal * 0.15;
                const total = subtotal + tax;
                
                const billData = {
                    customerAccountNumber: customer.accountNumber,
                    items: [itemData],
                    subtotal: subtotal,
                    discount: 0,
                    tax: tax,
                    total: total,
                    paymentMethod: 'cash',
                    transactionId: 'TXN' + Date.now(),
                    adminNotes: testName
                };
                
                console.log(`Sending ${testName} data:`, billData);
                
                const response = await fetch('http://localhost:8080/api/billing/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(billData)
                });
                
                console.log(`${testName} response status:`, response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`${testName} response result:`, result);
                    
                    if (result.success) {
                        resultDiv.innerHTML += `
                            <div class="result success">
                                ‚úÖ ${testName} generated successfully!<br>
                                Bill Number: ${result.bill.billNumber}<br>
                                Customer: ${result.bill.customerName}<br>
                                Total: Rs. ${result.bill.total}
                            </div>
                        `;
                        debugData.testResults.push({ name: testName, success: true, result });
                    } else {
                        resultDiv.innerHTML += `
                            <div class="result error">
                                ‚ùå ${testName} failed: ${result.message}
                            </div>
                        `;
                        debugData.testResults.push({ name: testName, success: false, error: result.message });
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`${testName} HTTP Error:`, response.status, errorText);
                    resultDiv.innerHTML += `
                        <div class="result error">
                            ‚ùå ${testName} HTTP Error: ${response.status} - ${errorText}
                        </div>
                    `;
                    debugData.testResults.push({ name: testName, success: false, error: errorText });
                }
            } catch (error) {
                console.error(`${testName} Error:`, error);
                resultDiv.innerHTML += `
                    <div class="result error">
                        ‚ùå ${testName} Error: ${error.message}
                    </div>
                `;
                debugData.testResults.push({ name: testName, success: false, error: error.message });
            }
        }

        async function checkAllBills() {
            const resultDiv = document.getElementById('all-bills');
            resultDiv.innerHTML = '<div class="loading">Checking all bills...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/admin/bills');
                if (response.ok) {
                    const bills = await response.json();
                    debugData.bills = bills;
                    
                    if (bills.length > 0) {
                        let html = `
                            <div class="result success">
                                ‚úÖ Found ${bills.length} bills in database:
                            </div>
                        `;
                        
                        bills.slice(0, 5).forEach(bill => {
                            html += `
                                <div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
                                    Bill: ${bill.billNumber} | Customer: ${bill.customerName} | Total: Rs. ${bill.total} | Date: ${new Date(bill.billDate).toLocaleDateString()}
                                </div>
                            `;
                        });
                        
                        if (bills.length > 5) {
                            html += `<div style="color: #6c757d; font-size: 0.9em;">... and ${bills.length - 5} more bills</div>`;
                        }
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result warning">
                                ‚ö†Ô∏è No bills found in database
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            ‚ùå Failed to fetch bills: ${response.status}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Error checking bills: ${error.message}
                    </div>
                `;
            }
        }

        function testFrontendForm() {
            const resultDiv = document.getElementById('frontend-form-test');
            resultDiv.innerHTML = '<div class="loading">Testing frontend form validation...</div>';
            
            // Simulate the form data that would be sent
            const formData = {
                customerAccountNumber: 'ACC123456',
                items: [
                    {
                        bookId: 'book1',
                        title: 'Test Book',
                        quantity: 2,
                        price: 1000
                    }
                ],
                subtotal: 2000,
                discount: 0,
                tax: 300,
                total: 2300,
                paymentMethod: 'cash',
                transactionId: 'TXN123',
                adminNotes: 'Frontend test'
            };
            
            // Validate the form data
            const errors = [];
            
            if (!formData.customerAccountNumber) {
                errors.push('Customer account number is required');
            }
            
            if (!formData.items || formData.items.length === 0) {
                errors.push('At least one item is required');
            }
            
            if (!formData.paymentMethod) {
                errors.push('Payment method is required');
            }
            
            if (errors.length > 0) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Frontend form validation failed:<br>
                        ${errors.join('<br>')}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="result success">
                        ‚úÖ Frontend form validation passed!<br>
                        Form data structure is correct.
                    </div>
                `;
            }
            
            debugData.testResults.push({ name: 'Frontend Form', success: errors.length === 0, data: formData });
        }

        function generateDebugReport() {
            const debugDiv = document.getElementById('debug-report');
            
            const report = {
                timestamp: new Date().toISOString(),
                backendStatus: debugData.backendStatus,
                mongodbBillsCount: debugData.mongodbBills.length,
                customersCount: debugData.customers.length,
                billsCount: debugData.bills.length,
                apiTests: debugData.apiTests,
                testResults: debugData.testResults,
                errors: debugData.errors,
                summary: {
                    backendWorking: debugData.backendStatus === 'online',
                    mongodbAccessible: debugData.mongodbBills.length >= 0,
                    customersAvailable: debugData.customers.length > 0,
                    billsGenerated: debugData.testResults.filter(r => r.success).length,
                    totalTests: debugData.testResults.length
                }
            };
            
            debugDiv.innerHTML = `
                <h4>üîç Complete Debug Report</h4>
                <pre>${JSON.stringify(report, null, 2)}</pre>
                
                <h4>üìä Summary</h4>
                <ul>
                    <li>Backend Status: ${report.summary.backendWorking ? '‚úÖ Online' : '‚ùå Offline'}</li>
                    <li>MongoDB Accessible: ${report.summary.mongodbAccessible ? '‚úÖ Yes' : '‚ùå No'}</li>
                    <li>Customers Available: ${report.summary.customersAvailable ? '‚úÖ Yes' : '‚ùå No'}</li>
                    <li>Bills Generated: ${report.summary.billsGenerated}/${report.summary.totalTests}</li>
                </ul>
            `;
        }

        // Auto-check backend on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkBackendStatus, 1000);
        });
    </script>
</body>
</html>
